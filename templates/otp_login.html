{% extends "base.html" %}

{% block title %}Login - {{ config.APP_NAME }}{% endblock %}

{% block content %}
<div class="otp-login-container">
    <!-- Phone Number Step -->
    <div id="phoneStep" class="otp-step active">
        <div class="otp-card">
            <div class="otp-header">
                <div class="logo">
                    <span class="logo-icon">üîß</span>
                    <span class="logo-text">{{ config.APP_NAME }}</span>
                </div>
                <h2>Sign in with your phone</h2>
                <p class="subtitle">We'll send you a one-time password (OTP).</p>
            </div>

            <form id="phoneForm">
                <div class="phone-input-group">
                    <label for="phoneNumber" class="input-label">Phone number</label>
                    <div class="phone-input-container">
                        <div class="country-selector">
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMTgiIHZpZXdCb3g9IjAgMCAyNCAxOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjYiIGZpbGw9IiNGRjY2MDAiLz4KPHJlY3QgeT0iNiIgd2lkdGg9IjI0IiBoZWlnaHQ9IjYiIGZpbGw9IiNGRkZGRkYiLz4KPHJlY3QgeT0iMTIiIHdpZHRoPSIyNCIgaGVpZ2h0PSI2IiBmaWxsPSIjMTM4ODA4Ii8+Cjwvc3ZnPgo=" alt="IN" class="flag-icon">
                            <span class="country-code">+91</span>
                            <svg class="dropdown-icon" width="12" height="8" viewBox="0 0 12 8" fill="none">
                                <path d="M1 1.5L6 6.5L11 1.5" stroke="#6B7280" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <input type="tel" id="phoneNumber" name="phone_number" class="phone-input" placeholder="555-555-5555" maxlength="10" required>
                    </div>
                </div>

                <button type="submit" class="otp-btn primary">Send OTP</button>
            </form>

            <div class="divider">
                <span>Or continue with</span>
            </div>

            <div class="social-buttons">
                <button class="social-btn" disabled>
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <path d="M17.64 9.205c0-.639-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 01-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/>
                        <path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 009 18z" fill="#34A853"/>
                        <path d="M3.964 10.71A5.41 5.41 0 013.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 000 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
                        <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 00.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/>
                    </svg>
                    Email
                </button>
                <button class="social-btn" disabled>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="#1877F2">
                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                    </svg>
                    Facebook
                </button>
            </div>

            <div class="signup-link">
                <span>Don't have an account? <a href="#" class="link">Sign up</a></span>
            </div>
        </div>
    </div>

    <!-- OTP Verification Step -->
    <div id="otpStep" class="otp-step">
        <div class="otp-card">
            <div class="otp-header">
                <div class="logo">
                    <span class="logo-icon">üîß</span>
                    <span class="logo-text">{{ config.APP_NAME }}</span>
                </div>
                <h2>Enter OTP</h2>
                <p class="subtitle">A 6-digit code has been sent to your phone.</p>
            </div>

            <form id="otpForm">
                <div class="otp-input-group">
                    <label class="input-label">Enter your OTP</label>
                    <div class="otp-inputs">
                        <input type="text" class="otp-digit" maxlength="1" autocomplete="off">
                        <input type="text" class="otp-digit" maxlength="1" autocomplete="off">
                        <input type="text" class="otp-digit" maxlength="1" autocomplete="off">
                        <input type="text" class="otp-digit" maxlength="1" autocomplete="off">
                        <input type="text" class="otp-digit" maxlength="1" autocomplete="off">
                        <input type="text" class="otp-digit" maxlength="1" autocomplete="off">
                    </div>
                </div>

                <div class="timer-section">
                    <span>Code expires in: <span id="timer" class="timer">02:00</span></span>
                </div>

                <button type="submit" id="verifyBtn" class="otp-btn primary">Verify</button>

                <div class="resend-section">
                    <span>Didn't receive the code? </span>
                    <button type="button" id="resendBtn" class="link resend-link" disabled>Resend OTP</button>
                </div>
            </form>

            <div class="back-link">
                <a href="{{ url_for('main.index') }}" class="link">‚Üê Back to Home</a>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Messages -->
    <div id="messageContainer" class="message-container"></div>
</div>
{% endblock %}

{% block head %}
<style>
.otp-login-container {
    min-height: 100vh;
    min-height: 100dvh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-4);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.otp-step {
    display: none;
}

.otp-step.active {
    display: block;
    animation: slideIn 0.3s ease-in-out;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.otp-card {
    background: white;
    border-radius: 16px;
    padding: var(--space-8);
    width: 100%;
    max-width: 400px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.otp-header {
    text-align: center;
    margin-bottom: var(--space-8);
}

.logo {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    margin-bottom: var(--space-6);
}

.logo-icon {
    font-size: 32px;
    color: #3B82F6;
}

.logo-text {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--gray-900);
}

.otp-header h2 {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--gray-900);
    margin: 0 0 var(--space-2) 0;
}

.subtitle {
    color: var(--gray-600);
    font-size: var(--font-size-sm);
    margin: 0;
}

.phone-input-group, .otp-input-group {
    margin-bottom: var(--space-6);
}

.input-label {
    display: block;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--gray-700);
    margin-bottom: var(--space-2);
}

.phone-input-container {
    display: flex;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    overflow: hidden;
    transition: border-color 0.2s;
}

.phone-input-container:focus-within {
    border-color: #3B82F6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.country-selector {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3);
    background: var(--gray-50);
    border-right: 1px solid var(--gray-300);
    cursor: pointer;
}

.flag-icon {
    width: 20px;
    height: 15px;
    border-radius: 2px;
}

.country-code {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--gray-700);
}

.dropdown-icon {
    color: var(--gray-500);
}

.phone-input {
    flex: 1;
    border: none;
    padding: var(--space-3);
    font-size: var(--font-size-base);
    outline: none;
}

.phone-input::placeholder {
    color: var(--gray-400);
}

.otp-inputs {
    display: flex;
    gap: var(--space-3);
    justify-content: center;
}

.otp-digit {
    width: 48px;
    height: 48px;
    border: 2px solid var(--gray-300);
    border-radius: 8px;
    text-align: center;
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    outline: none;
    transition: all 0.2s;
}

.otp-digit:focus {
    border-color: #3B82F6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.otp-digit.filled {
    border-color: #3B82F6;
    background: rgba(59, 130, 246, 0.05);
}

.timer-section {
    text-align: center;
    margin-bottom: var(--space-6);
    font-size: var(--font-size-sm);
    color: var(--gray-600);
}

.timer {
    font-weight: var(--font-weight-semibold);
    color: #EF4444;
}

.otp-btn {
    width: 100%;
    padding: var(--space-3);
    border: none;
    border-radius: 8px;
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: var(--space-6);
}

.otp-btn.primary {
    background: #3B82F6;
    color: white;
}

.otp-btn.primary:hover {
    background: #2563EB;
}

.otp-btn.primary:disabled {
    background: var(--gray-300);
    cursor: not-allowed;
}

.divider {
    text-align: center;
    margin: var(--space-6) 0;
    position: relative;
    color: var(--gray-500);
    font-size: var(--font-size-sm);
}

.divider::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: var(--gray-300);
    z-index: 1;
}

.divider span {
    background: white;
    padding: 0 var(--space-4);
    position: relative;
    z-index: 2;
}

.social-buttons {
    display: flex;
    gap: var(--space-3);
    margin-bottom: var(--space-6);
}

.social-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3);
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    background: white;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--gray-700);
    cursor: pointer;
    transition: all 0.2s;
}

.social-btn:hover:not(:disabled) {
    border-color: var(--gray-400);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.social-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.signup-link, .resend-section, .back-link {
    text-align: center;
    font-size: var(--font-size-sm);
    color: var(--gray-600);
}

.link {
    color: #3B82F6;
    text-decoration: none;
    font-weight: var(--font-weight-medium);
}

.link:hover {
    text-decoration: underline;
}

.resend-link:disabled {
    color: var(--gray-400);
    cursor: not-allowed;
    text-decoration: none;
}

.loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.loading-overlay.active {
    display: flex;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.message-container {
    position: fixed;
    top: var(--space-4);
    left: 50%;
    transform: translateX(-50%);
    z-index: 1001;
    max-width: 400px;
    width: 90%;
}

.message {
    padding: var(--space-3) var(--space-4);
    border-radius: 8px;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--space-2);
    animation: slideDown 0.3s ease-in-out;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.message.success {
    background: #10B981;
    color: white;
}

.message.error {
    background: #EF4444;
    color: white;
}

@media (max-width: 480px) {
    .otp-card {
        padding: var(--space-6);
        margin: var(--space-4);
    }

    .otp-inputs {
        gap: var(--space-2);
    }

    .otp-digit {
        width: 40px;
        height: 40px;
        font-size: var(--font-size-lg);
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const phoneStep = document.getElementById('phoneStep');
    const otpStep = document.getElementById('otpStep');
    const phoneForm = document.getElementById('phoneForm');
    const otpForm = document.getElementById('otpForm');
    const phoneInput = document.getElementById('phoneNumber');
    const otpInputs = document.querySelectorAll('.otp-digit');
    const resendBtn = document.getElementById('resendBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const messageContainer = document.getElementById('messageContainer');

    let currentPhone = '';
    let timerInterval;
    let resendTimer;

    // Phone input formatting
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 10) value = value.slice(0, 10);
        e.target.value = value;
    });

    // OTP digit inputs handling
    otpInputs.forEach((input, index) => {
        input.addEventListener('input', function(e) {
            const value = e.target.value.replace(/\D/g, '');
            e.target.value = value;

            if (value && index < otpInputs.length - 1) {
                otpInputs[index + 1].focus();
            }

            updateOtpInputs();

            // Auto-submit if all digits filled
            if (index === otpInputs.length - 1 && value) {
                const otpCode = Array.from(otpInputs).map(input => input.value).join('');
                if (otpCode.length === 6) {
                    setTimeout(() => verifyOtp(otpCode), 100);
                }
            }
        });

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                otpInputs[index - 1].focus();
            }
        });

        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);

            otpInputs.forEach((input, idx) => {
                input.value = pastedData[idx] || '';
            });

            updateOtpInputs();

            if (pastedData.length === 6) {
                setTimeout(() => verifyOtp(pastedData), 100);
            }
        });
    });

    function updateOtpInputs() {
        otpInputs.forEach(input => {
            if (input.value) {
                input.classList.add('filled');
            } else {
                input.classList.remove('filled');
            }
        });
    }

    // Phone form submission
    phoneForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const phoneNumber = phoneInput.value.trim();

        if (!phoneNumber) {
            showMessage('Please enter your phone number', 'error');
            return;
        }

        if (phoneNumber.length !== 10) {
            showMessage('Please enter a valid 10-digit phone number', 'error');
            return;
        }

        await sendOtp(phoneNumber);
    });

    // OTP form submission
    otpForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const otpCode = Array.from(otpInputs).map(input => input.value).join('');
        if (otpCode.length === 6) {
            verifyOtp(otpCode);
        }
    });

    // Resend OTP
    resendBtn.addEventListener('click', function() {
        if (!resendBtn.disabled) {
            sendOtp(currentPhone);
        }
    });

    async function sendOtp(phoneNumber) {
        showLoading(true);

        try {
            const response = await fetch('/api/otp/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ phone_number: phoneNumber })
            });

            const data = await response.json();

            if (data.success) {
                currentPhone = phoneNumber;
                switchToOtpStep();
                startTimer();
                showMessage('OTP sent successfully to your phone', 'success');
            } else {
                showMessage(data.message, 'error');
            }
        } catch (error) {
            showMessage('Network error. Please try again.', 'error');
        } finally {
            showLoading(false);
        }
    }

    async function verifyOtp(otpCode) {
        showLoading(true);

        try {
            const response = await fetch('/api/otp/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    phone_number: currentPhone,
                    otp_code: otpCode
                })
            });

            const data = await response.json();

            if (data.success) {
                showMessage('OTP verified successfully! Redirecting...', 'success');
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 1500);
            } else {
                showMessage(data.message, 'error');
                // Clear OTP inputs on error
                otpInputs.forEach(input => {
                    input.value = '';
                    input.classList.remove('filled');
                });
                otpInputs[0].focus();
            }
        } catch (error) {
            showMessage('Network error. Please try again.', 'error');
        } finally {
            showLoading(false);
        }
    }

    function switchToOtpStep() {
        phoneStep.classList.remove('active');
        otpStep.classList.add('active');
        setTimeout(() => otpInputs[0].focus(), 100);
    }

    function startTimer() {
        let timeLeft = 120; // 2 minutes
        const timerDisplay = document.getElementById('timer');

        clearInterval(timerInterval);
        clearTimeout(resendTimer);

        resendBtn.disabled = true;

        timerInterval = setInterval(() => {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                resendBtn.disabled = false;
                timerDisplay.textContent = '00:00';
            }
        }, 1000);

        // Enable resend after 30 seconds
        resendTimer = setTimeout(() => {
            resendBtn.disabled = false;
        }, 30000);
    }

    function showLoading(show) {
        if (show) {
            loadingOverlay.classList.add('active');
        } else {
            loadingOverlay.classList.remove('active');
        }
    }

    function showMessage(message, type = 'info') {
        const messageEl = document.createElement('div');
        messageEl.className = `message ${type}`;
        messageEl.textContent = message;

        messageContainer.appendChild(messageEl);

        setTimeout(() => {
            messageEl.remove();
        }, 5000);
    }

    // Auto-focus phone input
    phoneInput.focus();
});
</script>
{% endblock %}